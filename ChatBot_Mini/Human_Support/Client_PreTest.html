<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client P2P Test - Vanced Support</title>
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }
      .waiting {
        background: #fff3cd;
        color: #856404;
      }
      .connected {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .timeout {
        background: #f8d7da;
        color: #721c24;
      }

      .chat-area {
        border: 1px solid #ddd;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin: 10px 0;
        background: #fafafa;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
      }
      .user-msg {
        background: #007bff;
        color: white;
        text-align: right;
      }
      .admin-msg {
        background: #28a745;
        color: white;
        text-align: left;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      input[type="text"] {
        width: 70%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª Client P2P Test - Vanced Support</h1>
      <div style="margin-bottom: 20px">
        <p>
          <strong>Base MachineID:</strong>
          <span id="baseMachineId">20250909S5690</span>
        </p>
        <div style="margin: 10px 0">
          <label for="machineIdSuffix"
            ><strong>Suffix (Ä‘á»ƒ test multiple clients):</strong></label
          >
          <input
            type="text"
            id="machineIdSuffix"
            placeholder="Nháº­p suffix..."
            style="width: 200px; margin-left: 10px"
            onchange="updateMachineId()"
            onkeyup="updateMachineId()"
          />
        </div>
        <p>
          <strong>Final MachineID:</strong>
          <span id="finalMachineId" style="color: #007bff; font-weight: bold"
            >20250909S5690</span
          >
        </p>
      </div>

      <div id="statusArea">
        <div class="status waiting" id="statusMsg">
          Sáºµn sÃ ng test P2P connection
        </div>
      </div>

      <div id="controlArea">
        <button id="requestSupportBtn" onclick="requestHumanSupport()">
          ğŸ†˜ YÃªu cáº§u gáº·p tÆ° váº¥n viÃªn
        </button>
        <button id="testSpreadsheetBtn" onclick="testSpreadsheetConnection()">
          ğŸ“Š Test Spreadsheet Connection
        </button>
        <button id="testPeerJSBtn" onclick="testPeerJSConnection()">
          ğŸ”— Test PeerJS Server
        </button>
        <button id="clearCacheBtn" onclick="clearBrowserCache()">
          ğŸ—‘ï¸ Clear Cache & Reload
        </button>
      </div>

      <div id="waitingArea" style="display: none">
        <h3>â³ Äang chá» tÆ° váº¥n viÃªn...</h3>
        <p>Thá»i gian chá»: <span id="countdown">180</span> giÃ¢y</p>
        <div id="peerInfo">
          <p><strong>PeerID:</strong> <span id="currentPeerID">-</span></p>
        </div>
      </div>

      <div id="chatArea" style="display: none">
        <h3>ğŸ’¬ Chat vá»›i tÆ° váº¥n viÃªn</h3>
        <div class="chat-area" id="chatMessages"></div>
        <div>
          <input
            type="text"
            id="messageInput"
            placeholder="Nháº­p tin nháº¯n..."
            onkeypress="if(event.key==='Enter') sendMessage()"
          />
          <button onclick="sendMessage()">Gá»­i</button>
          <button onclick="endChat()" style="background: #dc3545">
            Káº¿t thÃºc
          </button>
        </div>
      </div>

      <div id="debugArea">
        <h4>ğŸ”§ Debug Info</h4>
        <div
          id="debugLog"
          style="
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
          "
        ></div>
      </div>
    </div>

    <script>
      // Configuration
      const BASE_MACHINE_ID = "20250909S5690";
      const SPREADSHEET_URL =
        "https://script.google.com/macros/s/AKfycbzZPxkICg1AHucIZ2AFQmnLLg_hjG8s9ouJUU9eSG1043AronwRwV45i5tMOQT5VuPDvw/exec"; // Cáº­p nháº­t URL nÃ y

      // Global variables
      let peer = null;
      let connection = null;
      let countdownTimer = null;
      let isConnected = false;
      let currentMachineId = BASE_MACHINE_ID;

      // Update MachineID with suffix
      function updateMachineId() {
        const suffix = document.getElementById("machineIdSuffix").value.trim();
        currentMachineId = suffix
          ? `${BASE_MACHINE_ID}_${suffix}`
          : BASE_MACHINE_ID;

        document.getElementById("finalMachineId").textContent =
          currentMachineId;
        debugLog("MachineID updated", {
          baseMachineId: BASE_MACHINE_ID,
          suffix: suffix,
          finalMachineId: currentMachineId,
        });
      }

      // Debug logging
      function debugLog(message, data = null) {
        const timestamp = new Date().toISOString();
        const logMessage = `[${timestamp}] ${message}`;

        console.log(logMessage, data || "");

        const debugArea = document.getElementById("debugLog");
        const logEntry = document.createElement("div");
        logEntry.textContent =
          logMessage + (data ? ` | ${JSON.stringify(data)}` : "");
        debugArea.appendChild(logEntry);
        debugArea.scrollTop = debugArea.scrollHeight;
      }

      // Update status display
      function updateStatus(message, type = "waiting") {
        const statusMsg = document.getElementById("statusMsg");
        statusMsg.textContent = message;
        statusMsg.className = `status ${type}`;
        debugLog(`Status: ${message} (${type})`);
      }

      // Test Spreadsheet connection
      async function testSpreadsheetConnection() {
        updateStatus("Testing Spreadsheet connection...", "waiting");

        try {
          const url = new URL(SPREADSHEET_URL);
          url.searchParams.append("action", "initChat");
          url.searchParams.append("machineId", currentMachineId);
          url.searchParams.append("userIP", "test-ip");

          debugLog("Testing Spreadsheet connection", { url: url.toString() });

          const response = await fetch(url.toString());
          const data = await response.json();

          debugLog("Spreadsheet response", data);

          if (data.status === "existing_user" || data.status === "new_user") {
            updateStatus("âœ… Spreadsheet connection successful!", "connected");
          } else {
            updateStatus("âŒ Spreadsheet connection failed", "error");
          }
        } catch (error) {
          debugLog("Spreadsheet connection error", error.message);
          updateStatus("âŒ Spreadsheet connection error", "error");
        }
      }

      // Request human support
      async function requestHumanSupport() {
        updateStatus("Khá»Ÿi táº¡o P2P connection...", "waiting");

        // Generate custom PeerID
        const peerID = `vanced_${currentMachineId}_${Date.now()}`;
        debugLog("Generated PeerID", {
          machineId: currentMachineId,
          peerID: peerID,
        });

        try {
          // Add connection timeout
          const connectionTimeout = setTimeout(() => {
            debugLog("PeerJS connection timeout");
            updateStatus("â° Timeout káº¿t ná»‘i PeerJS server", "error");
            if (peer) {
              peer.destroy();
            }
          }, 10000); // 10 seconds timeout

          // Initialize PeerJS with explicit config
          peer = new Peer(peerID, {
            debug: 2, // Enable debug logging
            config: {
              iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:global.stun.twilio.com:3478" },
              ],
            },
          });

          peer.on("open", (id) => {
            clearTimeout(connectionTimeout);
            debugLog("Peer opened successfully", {
              id: id,
              expectedId: peerID,
              match: id === peerID,
            });
            document.getElementById("currentPeerID").textContent = id;

            // Save to Spreadsheet
            savePeerIDToSpreadsheet(id);

            // Show waiting UI
            showWaitingUI();

            // Start countdown
            startCountdown();
          });

          peer.on("connection", (conn) => {
            debugLog("Admin connected!", conn.peer);
            connection = conn;
            isConnected = true;

            // Stop countdown
            if (countdownTimer) {
              clearInterval(countdownTimer);
            }

            // Setup connection handlers
            setupConnection(conn);

            // Show chat UI
            showChatUI();
            updateStatus("âœ… ÄÃ£ káº¿t ná»‘i vá»›i tÆ° váº¥n viÃªn!", "connected");
          });

          peer.on("error", (error) => {
            clearTimeout(connectionTimeout);
            debugLog("Peer error details", {
              type: error.type,
              message: error.message,
              error: error,
            });

            let errorMessage = "âŒ Lá»—i P2P connection";
            if (error.type === "network") {
              errorMessage = "âŒ Lá»—i máº¡ng - Kiá»ƒm tra internet";
            } else if (error.type === "server-error") {
              errorMessage = "âŒ PeerJS server lá»—i - Thá»­ láº¡i sau";
            } else if (error.type === "unavailable-id") {
              errorMessage = "âŒ PeerID Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng";
            }

            updateStatus(errorMessage, "error");
          });

          peer.on("disconnected", () => {
            debugLog("Peer disconnected from server");
            updateStatus("âš ï¸ Máº¥t káº¿t ná»‘i tá»›i PeerJS server", "error");
          });

          peer.on("close", () => {
            debugLog("Peer connection closed");
            updateStatus("âŒ PeerJS connection Ä‘Ã£ Ä‘Ã³ng", "error");
          });
        } catch (error) {
          debugLog("Request support error", error.message);
          updateStatus("âŒ Lá»—i khá»Ÿi táº¡o P2P", "error");
        }
      }

      // Save PeerID to Spreadsheet
      async function savePeerIDToSpreadsheet(peerID) {
        try {
          const p2pData = {
            clientPeerID: peerID,
            adminPeerID: null,
            status: "waiting",
            adminNickname: null,
            timestamp: new Date().toISOString(),
            connectionStartTime: null,
          };

          const url = new URL(SPREADSHEET_URL);
          url.searchParams.append("action", "updateP2PRequest");
          url.searchParams.append("machineId", currentMachineId);
          url.searchParams.append("p2pData", JSON.stringify(p2pData));

          debugLog("Saving PeerID to Spreadsheet", p2pData);

          const response = await fetch(url.toString());
          const data = await response.json();

          debugLog("Spreadsheet save response", data);
        } catch (error) {
          debugLog("Save PeerID error", error.message);
        }
      }

      // Show waiting UI
      function showWaitingUI() {
        document.getElementById("controlArea").style.display = "none";
        document.getElementById("waitingArea").style.display = "block";
      }

      // Show chat UI
      function showChatUI() {
        document.getElementById("waitingArea").style.display = "none";
        document.getElementById("chatArea").style.display = "block";
      }

      // Start countdown timer
      function startCountdown() {
        let timeLeft = 180; // 3 minutes
        const countdownElement = document.getElementById("countdown");

        countdownTimer = setInterval(() => {
          timeLeft--;
          countdownElement.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(countdownTimer);
            handleTimeout();
          }
        }, 1000);
      }

      // Handle timeout
      function handleTimeout() {
        if (!isConnected) {
          updateStatus("â° Timeout - KhÃ´ng cÃ³ tÆ° váº¥n viÃªn káº¿t ná»‘i", "timeout");

          if (peer) {
            peer.destroy();
          }

          // Show fallback options
          alert(
            "KhÃ´ng cÃ³ tÆ° váº¥n viÃªn trá»±c tuyáº¿n. Vui lÃ²ng liÃªn há»‡:\nEmail: contact@vanced.agency\nPhone: 0123-456-789"
          );
        }
      }

      // Setup connection handlers
      function setupConnection(conn) {
        conn.on("data", (data) => {
          debugLog("Received message", data);
          displayMessage(data.message, "admin");
        });

        conn.on("close", () => {
          debugLog("Connection closed by admin");
          updateStatus("âŒ TÆ° váº¥n viÃªn Ä‘Ã£ ngáº¯t káº¿t ná»‘i", "error");
          isConnected = false;
        });

        conn.on("error", (error) => {
          debugLog("Connection error", error);
          updateStatus("âŒ Lá»—i káº¿t ná»‘i P2P", "error");
        });
      }

      // Send message
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message || !connection) return;

        // Display message locally
        displayMessage(message, "user");

        // Send to admin
        connection.send({
          type: "message",
          message: message,
          timestamp: new Date().toISOString(),
          from: "client",
        });

        debugLog("Sent message", message);
        input.value = "";
      }

      // Display message in chat
      function displayMessage(message, sender) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          sender === "user" ? "user-msg" : "admin-msg"
        }`;
        messageDiv.textContent = `${
          sender === "user" ? "Báº¡n" : "TÆ° váº¥n viÃªn"
        }: ${message}`;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // End chat
      function endChat() {
        if (connection) {
          connection.send({
            type: "end_chat",
            timestamp: new Date().toISOString(),
            from: "client",
          });

          connection.close();
        }

        if (peer) {
          peer.destroy();
        }

        updateStatus("âœ… ÄÃ£ káº¿t thÃºc cuá»™c trÃ² chuyá»‡n", "connected");

        // Reset UI
        document.getElementById("controlArea").style.display = "block";
        document.getElementById("waitingArea").style.display = "none";
        document.getElementById("chatArea").style.display = "none";

        // Clear chat messages
        document.getElementById("chatMessages").innerHTML = "";

        debugLog("Chat ended by client");
      }

      // Test PeerJS server connection
      async function testPeerJSConnection() {
        updateStatus("Testing PeerJS server...", "waiting");

        try {
          const testPeerID = `test_${Date.now()}`;
          debugLog("Testing PeerJS with ID", testPeerID);

          const testPeer = new Peer(testPeerID, {
            debug: 2,
          });

          const testTimeout = setTimeout(() => {
            debugLog("PeerJS test timeout");
            updateStatus("âŒ PeerJS server khÃ´ng pháº£n há»“i", "error");
            testPeer.destroy();
          }, 8000);

          testPeer.on("open", (id) => {
            clearTimeout(testTimeout);
            debugLog("PeerJS test successful", id);
            updateStatus(
              "âœ… PeerJS server hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng!",
              "connected"
            );
            testPeer.destroy();
          });

          testPeer.on("error", (error) => {
            clearTimeout(testTimeout);
            debugLog("PeerJS test error", error);
            updateStatus(`âŒ PeerJS server lá»—i: ${error.type}`, "error");
          });
        } catch (error) {
          debugLog("PeerJS test exception", error);
          updateStatus("âŒ Lá»—i test PeerJS", "error");
        }
      }

      // Clear browser cache and reload
      function clearBrowserCache() {
        debugLog("Clearing cache and reloading");

        // Clear localStorage
        localStorage.clear();

        // Clear sessionStorage
        sessionStorage.clear();

        // Force reload without cache
        location.reload(true);
      }

      // Initialize on page load
      window.onload = function () {
        debugLog("Client PreTest initialized", {
          baseMachineId: BASE_MACHINE_ID,
          currentMachineId: currentMachineId,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString(),
        });
        updateStatus("Sáºµn sÃ ng test P2P connection", "waiting");

        // Auto test PeerJS on load
        setTimeout(() => {
          debugLog("Auto-testing PeerJS server on load");
          testPeerJSConnection();
        }, 1000);
      };

      // Cleanup on page unload
      window.onbeforeunload = function () {
        if (peer) {
          peer.destroy();
        }
      };
    </script>
  </body>
</html>
