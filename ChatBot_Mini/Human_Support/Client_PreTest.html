<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client P2P Test - Vanced Support</title>
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }
      .waiting {
        background: #fff3cd;
        color: #856404;
      }
      .connected {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .timeout {
        background: #f8d7da;
        color: #721c24;
      }

      .chat-area {
        border: 1px solid #ddd;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin: 10px 0;
        background: #fafafa;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
      }
      .user-msg {
        background: #007bff;
        color: white;
        text-align: right;
      }
      .admin-msg {
        background: #28a745;
        color: white;
        text-align: left;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      input[type="text"] {
        width: 70%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
    </style>
  </head>
  <body></body>
</html>
    <div class="container">
        <h1>üß™ Client P2P Test - Vanced Support</h1>
        <p><strong>MachineID:</strong> <span id="machineId">20250909S5690</span></p>
        
        <div id="statusArea">
            <div class="status waiting" id="statusMsg">
                S·∫µn s√†ng test P2P connection
            </div>
        </div>

        <div id="controlArea">
            <button id="requestSupportBtn" onclick="requestHumanSupport()">
                üÜò Y√™u c·∫ßu g·∫∑p t∆∞ v·∫•n vi√™n
            </button>
            <button id="testSpreadsheetBtn" onclick="testSpreadsheetConnection()">
                üìä Test Spreadsheet Connection
            </button>
        </div>

        <div id="waitingArea" style="display: none;">
            <h3>‚è≥ ƒêang ch·ªù t∆∞ v·∫•n vi√™n...</h3>
            <p>Th·ªùi gian ch·ªù: <span id="countdown">180</span> gi√¢y</p>
            <div id="peerInfo">
                <p><strong>PeerID:</strong> <span id="currentPeerID">-</span></p>
            </div>
        </div>

        <div id="chatArea" style="display: none;">
            <h3>üí¨ Chat v·ªõi t∆∞ v·∫•n vi√™n</h3>
            <div class="chat-area" id="chatMessages"></div>
            <div>
                <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." 
                       onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()">G·ª≠i</button>
                <button onclick="endChat()" style="background: #dc3545;">K·∫øt th√∫c</button>
            </div>
        </div>

        <div id="debugArea">
            <h4>üîß Debug Info</h4>
            <div id="debugLog" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // Configuration
        const MACHINE_ID = "20250909S5690";
        const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbwYour_Spreadsheet_URL_Here/exec"; // C·∫≠p nh·∫≠t URL n√†y
        
        // Global variables
        let peer = null;
        let connection = null;
        let countdownTimer = null;
        let isConnected = false;
        
        // Debug logging
        function debugLog(message, data = null) {
            const timestamp = new Date().toISOString();
            const logMessage = `[${timestamp}] ${message}`;
            
            console.log(logMessage, data || '');
            
            const debugArea = document.getElementById('debugLog');
            const logEntry = document.createElement('div');
            logEntry.textContent = logMessage + (data ? ` | ${JSON.stringify(data)}` : '');
            debugArea.appendChild(logEntry);
            debugArea.scrollTop = debugArea.scrollHeight;
        }  
      
        // Update status display
        function updateStatus(message, type = 'waiting') {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = message;
            statusMsg.className = `status ${type}`;
            debugLog(`Status: ${message} (${type})`);
        }
        
        // Test Spreadsheet connection
        async function testSpreadsheetConnection() {
            updateStatus('Testing Spreadsheet connection...', 'waiting');
            
            try {
                const url = new URL(SPREADSHEET_URL);
                url.searchParams.append('action', 'initChat');
                url.searchParams.append('machineId', MACHINE_ID);
                url.searchParams.append('userIP', 'test-ip');
                
                debugLog('Testing Spreadsheet connection', { url: url.toString() });
                
                const response = await fetch(url.toString());
                const data = await response.json();
                
                debugLog('Spreadsheet response', data);
                
                if (data.status === 'existing_user' || data.status === 'new_user') {
                    updateStatus('‚úÖ Spreadsheet connection successful!', 'connected');
                } else {
                    updateStatus('‚ùå Spreadsheet connection failed', 'error');
                }
            } catch (error) {
                debugLog('Spreadsheet connection error', error.message);
                updateStatus('‚ùå Spreadsheet connection error', 'error');
            }
        }
        
        // Request human support
        async function requestHumanSupport() {
            updateStatus('Kh·ªüi t·∫°o P2P connection...', 'waiting');
            
            // Generate custom PeerID
            const peerID = `vanced_${MACHINE_ID}_${Date.now()}`;
            debugLog('Generated PeerID', peerID);
            
            try {
                // Initialize PeerJS
                peer = new Peer(peerID);
                
                peer.on('open', (id) => {
                    debugLog('Peer opened', id);
                    document.getElementById('currentPeerID').textContent = id;
                    
                    // Save to Spreadsheet
                    savePeerIDToSpreadsheet(id);
                    
                    // Show waiting UI
                    showWaitingUI();
                    
                    // Start countdown
                    startCountdown();
                });
                
                peer.on('connection', (conn) => {
                    debugLog('Admin connected!', conn.peer);
                    connection = conn;
                    isConnected = true;
                    
                    // Stop countdown
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                    }
                    
                    // Setup connection handlers
                    setupConnection(conn);
                    
                    // Show chat UI
                    showChatUI();
                    updateStatus('‚úÖ ƒê√£ k·∫øt n·ªëi v·ªõi t∆∞ v·∫•n vi√™n!', 'connected');
                });
                
                peer.on('error', (error) => {
                    debugLog('Peer error', error);
                    updateStatus('‚ùå L·ªói P2P connection', 'error');
                });
                
            } catch (error) {
                debugLog('Request support error', error.message);
                updateStatus('‚ùå L·ªói kh·ªüi t·∫°o P2P', 'error');
            }
        }  
      
        // Save PeerID to Spreadsheet
        async function savePeerIDToSpreadsheet(peerID) {
            try {
                const p2pData = {
                    clientPeerID: peerID,
                    adminPeerID: null,
                    status: "waiting",
                    adminNickname: null,
                    timestamp: new Date().toISOString(),
                    connectionStartTime: null
                };
                
                const url = new URL(SPREADSHEET_URL);
                url.searchParams.append('action', 'updateP2PRequest');
                url.searchParams.append('machineId', MACHINE_ID);
                url.searchParams.append('p2pData', JSON.stringify(p2pData));
                
                debugLog('Saving PeerID to Spreadsheet', p2pData);
                
                const response = await fetch(url.toString());
                const data = await response.json();
                
                debugLog('Spreadsheet save response', data);
                
            } catch (error) {
                debugLog('Save PeerID error', error.message);
            }
        }
        
        // Show waiting UI
        function showWaitingUI() {
            document.getElementById('controlArea').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'block';
        }
        
        // Show chat UI
        function showChatUI() {
            document.getElementById('waitingArea').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
        }
        
        // Start countdown timer
        function startCountdown() {
            let timeLeft = 180; // 3 minutes
            const countdownElement = document.getElementById('countdown');
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    handleTimeout();
                }
            }, 1000);
        }
        
        // Handle timeout
        function handleTimeout() {
            if (!isConnected) {
                updateStatus('‚è∞ Timeout - Kh√¥ng c√≥ t∆∞ v·∫•n vi√™n k·∫øt n·ªëi', 'timeout');
                
                if (peer) {
                    peer.destroy();
                }
                
                // Show fallback options
                alert('Kh√¥ng c√≥ t∆∞ v·∫•n vi√™n tr·ª±c tuy·∫øn. Vui l√≤ng li√™n h·ªá:\nEmail: contact@vanced.agency\nPhone: 0123-456-789');
            }
        }
        
        // Setup connection handlers
        function setupConnection(conn) {
            conn.on('data', (data) => {
                debugLog('Received message', data);
                displayMessage(data.message, 'admin');
            });
            
            conn.on('close', () => {
                debugLog('Connection closed by admin');
                updateStatus('‚ùå T∆∞ v·∫•n vi√™n ƒë√£ ng·∫Øt k·∫øt n·ªëi', 'error');
                isConnected = false;
            });
            
            conn.on('error', (error) => {
                debugLog('Connection error', error);
                updateStatus('‚ùå L·ªói k·∫øt n·ªëi P2P', 'error');
            });
        }       
 
        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !connection) return;
            
            // Display message locally
            displayMessage(message, 'user');
            
            // Send to admin
            connection.send({
                type: 'message',
                message: message,
                timestamp: new Date().toISOString(),
                from: 'client'
            });
            
            debugLog('Sent message', message);
            input.value = '';
        }
        
        // Display message in chat
        function displayMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'user-msg' : 'admin-msg'}`;
            messageDiv.textContent = `${sender === 'user' ? 'B·∫°n' : 'T∆∞ v·∫•n vi√™n'}: ${message}`;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // End chat
        function endChat() {
            if (connection) {
                connection.send({
                    type: 'end_chat',
                    timestamp: new Date().toISOString(),
                    from: 'client'
                });
                
                connection.close();
            }
            
            if (peer) {
                peer.destroy();
            }
            
            updateStatus('‚úÖ ƒê√£ k·∫øt th√∫c cu·ªôc tr√≤ chuy·ªán', 'connected');
            
            // Reset UI
            document.getElementById('controlArea').style.display = 'block';
            document.getElementById('waitingArea').style.display = 'none';
            document.getElementById('chatArea').style.display = 'none';
            
            // Clear chat messages
            document.getElementById('chatMessages').innerHTML = '';
            
            debugLog('Chat ended by client');
        }
        
        // Initialize on page load
        window.onload = function() {
            debugLog('Client PreTest initialized', { machineId: MACHINE_ID });
            updateStatus('S·∫µn s√†ng test P2P connection', 'waiting');
        };
        
        // Cleanup on page unload
        window.onbeforeunload = function() {
            if (peer) {
                peer.destroy();
            }
        };
    </script>
</body>
</html>