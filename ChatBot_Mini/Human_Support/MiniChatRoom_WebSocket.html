<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mini Chat Room - WebSocket</title>
    <!-- Sá»­a file style.scss thay vÃ¬ style.css, file .scss sáº½ tá»± compile ra file .css -->
    <link rel="stylesheet" href="./styles/style.css" />
    <!--  -->
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ’¬ Mini Chat Room</h1>
        <p>WebSocket Chat - Hoáº¡t Ä‘á»™ng qua má»i máº¡ng</p>
      </div>

      <!-- Login Screen -->
      <div class="login-screen" id="loginScreen">
        <div class="login-form">
          <h2>Tham gia Chat Room</h2>
          <div class="input-group">
            <label for="nickname">Nickname cá»§a báº¡n:</label>
            <input
              type="text"
              id="nickname"
              placeholder="Nháº­p tÃªn hiá»ƒn thá»‹..."
              maxlength="20"
            />
          </div>
          <div class="input-group">
            <label for="roomId">Room ID:</label>
            <select id="roomId">
              <option value="public-room-1">ğŸŒ Public Room 1</option>
              <option value="public-room-2">ğŸ® Gaming Room</option>
              <option value="public-room-3">ğŸ’¼ Work Chat</option>
              <option value="custom">ğŸ”§ Custom Room</option>
            </select>
          </div>
          <div class="input-group" id="customRoomGroup" style="display: none">
            <label for="customRoom">Custom Room ID:</label>
            <input
              type="text"
              id="customRoom"
              placeholder="Nháº­p room ID tÃ¹y chá»‰nh..."
            />
          </div>
          <button class="btn" id="joinBtn" onclick="joinRoom()">
            Tham gia Chat
          </button>
        </div>
      </div>

      <!-- Chat Screen -->
      <div class="chat-screen" id="chatScreen">
        <div class="chat-info">
          <div class="user-info" id="userInfo"></div>
          <div class="room-info" id="roomInfo"></div>
        </div>
        <div class="users-list" id="usersList" style="display: none"></div>
        <div class="status" id="connectionStatus">Äang káº¿t ná»‘i...</div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="message-input">
          <input
            type="text"
            id="messageInput"
            placeholder="Nháº­p tin nháº¯n..."
            maxlength="500"
          />
          <button class="send-btn" onclick="sendMessage()">Gá»­i</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = {
        nickname: "",
        peerID: "",
        roomID: "",
      };

      let chatSocket = null;
      let connectedUsers = new Set(); // Set of connected user IDs in room
      let messageQueue = []; // Queue messages until connected
      let reconnectAttempts = 0;
      let maxReconnectAttempts = 5;
      let reconnectDelay = 1000; // Start with 1 second
      let pingInterval = null;
      let isConnecting = false;
      let isManualDisconnect = false;

      const CHAT_SERVER =
        "wss://vanced-chatbot.caocv-work.workers.dev/p2p/room/";

      // UI Event Handlers
      document.getElementById("roomId").addEventListener("change", function () {
        const customGroup = document.getElementById("customRoomGroup");
        if (this.value === "custom") {
          customGroup.style.display = "block";
        } else {
          customGroup.style.display = "none";
        }
      });

      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      document
        .getElementById("nickname")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            joinRoom();
          }
        });

      // Generate unique peer ID
      function generatePeerID() {
        return (
          "user_" +
          Math.random().toString(36).substr(2, 9) +
          "_" +
          Date.now().toString(36)
        );
      }

      // Join room function
      async function joinRoom() {
        const nickname = document.getElementById("nickname").value.trim();
        const roomSelect = document.getElementById("roomId").value;

        let roomID;
        if (roomSelect === "custom") {
          roomID = document.getElementById("customRoom").value.trim();
          if (!roomID) {
            alert("Vui lÃ²ng nháº­p Room ID tÃ¹y chá»‰nh!");
            return;
          }
        } else {
          roomID = roomSelect;
        }

        if (!nickname) {
          alert("Vui lÃ²ng nháº­p nickname!");
          return;
        }

        // Set user info
        currentUser.nickname = nickname;
        currentUser.peerID = generatePeerID();
        currentUser.roomID = roomID;

        // Switch to chat screen
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("chatScreen").style.display = "flex";

        // Update UI
        document.getElementById("userInfo").textContent = `ğŸ‘¤ ${nickname}`;
        document.getElementById("roomInfo").textContent = `ğŸ  ${roomID}`;

        // Connect to chat server
        await connectToChatServer();
      }

      // Connect to chat server with auto-reconnect
      async function connectToChatServer() {
        if (isConnecting) {
          console.log("Already connecting, skipping...");
          return;
        }

        isConnecting = true;

        try {
          updateStatus("Äang káº¿t ná»‘i Ä‘áº¿n chat server...", "info");

          const wsUrl = `${CHAT_SERVER}${currentUser.roomID}?peerID=${
            currentUser.peerID
          }&roomID=${currentUser.roomID}&nickname=${encodeURIComponent(
            currentUser.nickname
          )}`;
          chatSocket = new WebSocket(wsUrl);

          chatSocket.onopen = () => {
            updateStatus("âœ… ÄÃ£ káº¿t ná»‘i - Sáºµn sÃ ng chat!", "success");
            console.log("Connected to chat server");

            // Reset reconnect attempts on successful connection
            reconnectAttempts = 0;
            reconnectDelay = 1000;
            isConnecting = false;

            // Send queued messages
            while (messageQueue.length > 0) {
              const queuedMessage = messageQueue.shift();
              sendMessageViaWebSocket(queuedMessage);
            }

            // Start ping interval to keep connection alive
            startPingInterval();
          };

          chatSocket.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            await handleChatMessage(message);
          };

          chatSocket.onclose = (event) => {
            console.log("WebSocket closed:", event.code, event.reason);
            isConnecting = false;
            stopPingInterval();

            if (!isManualDisconnect) {
              updateStatus("âŒ Máº¥t káº¿t ná»‘i Ä‘áº¿n server", "error");
              attemptReconnect();
            }
          };

          chatSocket.onerror = (error) => {
            console.error("Chat socket error:", error);
            isConnecting = false;
            updateStatus("âŒ Lá»—i káº¿t ná»‘i WebSocket", "error");
          };
        } catch (error) {
          isConnecting = false;
          updateStatus("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i: " + error.message, "error");
          console.error("Connection error:", error);
          attemptReconnect();
        }
      }

      // Start ping interval to keep connection alive
      function startPingInterval() {
        stopPingInterval(); // Clear any existing interval

        pingInterval = setInterval(() => {
          if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ type: "ping" }));
            console.log("Sent ping to server");
          } else {
            stopPingInterval();
          }
        }, 30000); // Ping every 30 seconds
      }

      // Stop ping interval
      function stopPingInterval() {
        if (pingInterval) {
          clearInterval(pingInterval);
          pingInterval = null;
        }
      }

      // Attempt to reconnect with exponential backoff
      function attemptReconnect() {
        if (isManualDisconnect || reconnectAttempts >= maxReconnectAttempts) {
          if (reconnectAttempts >= maxReconnectAttempts) {
            updateStatus(
              "âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i láº¡i. Vui lÃ²ng refresh trang.",
              "error"
            );
          }
          return;
        }

        reconnectAttempts++;
        const delay = Math.min(
          reconnectDelay * Math.pow(2, reconnectAttempts - 1),
          30000
        );

        updateStatus(
          `ğŸ”„ Äang thá»­ káº¿t ná»‘i láº¡i... (${reconnectAttempts}/${maxReconnectAttempts})`,
          "info"
        );

        setTimeout(() => {
          if (!isManualDisconnect) {
            connectToChatServer();
          }
        }, delay);
      }

      // Handle chat messages
      async function handleChatMessage(message) {
        console.log("Received chat message:", message);

        switch (message.type) {
          case "connected":
            updateStatus(`âœ… ÄÃ£ tham gia room: ${message.roomID}`, "success");
            // Request user list
            chatSocket.send(JSON.stringify({ type: "get-users" }));
            break;

          case "user-joined":
            if (message.peerID !== currentUser.peerID) {
              const nickname = message.nickname || message.peerID;
              updateStatus(`ğŸ‘‹ ${nickname} Ä‘Ã£ tham gia`, "info");
              connectedUsers.add(message.peerID);
              updateUsersDisplay();
            }
            break;

          case "user-left":
            if (message.peerID !== currentUser.peerID) {
              const nickname = message.nickname || message.peerID;
              updateStatus(`ğŸ‘‹ ${nickname} Ä‘Ã£ rá»i khá»i room`, "info");
              connectedUsers.delete(message.peerID);
              updateUsersDisplay();
            }
            break;

          case "user-list":
            updateUsersList(message.users);
            break;

          case "chat-message":
            // Display received message
            if (message.fromPeerID !== currentUser.peerID) {
              displayMessage(message, false);
            }
            break;

          case "pong":
            console.log("Received pong from server - connection alive");
            break;

          default:
            console.log("Unknown message type:", message.type);
        }
      }

      // Send message
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const messageText = input.value.trim();

        if (!messageText) return;

        const message = {
          from: currentUser.nickname,
          fromPeerID: currentUser.peerID,
          text: messageText,
          timestamp: new Date().toISOString(),
        };

        // Display own message
        displayMessage(message, true);

        // Send via WebSocket or queue
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
          sendMessageViaWebSocket(message);
        } else {
          messageQueue.push(message);
          updateStatus("ğŸ“¤ Tin nháº¯n Ä‘Ã£ Ä‘Æ°á»£c xáº¿p hÃ ng chá» káº¿t ná»‘i", "info");
        }

        input.value = "";
      }

      // Send message via WebSocket
      function sendMessageViaWebSocket(message) {
        chatSocket.send(
          JSON.stringify({
            type: "chat-message",
            from: message.from,
            fromPeerID: message.fromPeerID,
            text: message.text,
            timestamp: message.timestamp,
            roomID: currentUser.roomID,
          })
        );
      }

      // Display message in UI
      function displayMessage(message, isOwn) {
        const container = document.getElementById("messagesContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isOwn ? "own" : "other"}`;

        const time = new Date(message.timestamp).toLocaleTimeString("vi-VN", {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
                <div class="message-header">${
                  isOwn ? "Báº¡n" : message.from
                } â€¢ ${time}</div>
                <div>${escapeHtml(message.text)}</div>
            `;

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }

      // Update status
      function updateStatus(message, type = "info") {
        const statusDiv = document.getElementById("connectionStatus");
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }

      // Update users list
      function updateUsersList(users) {
        const usersDiv = document.getElementById("usersList");

        if (users.length <= 1) {
          usersDiv.style.display = "none";
          return;
        }

        usersDiv.style.display = "block";
        const otherUsers = users.filter((u) => u.peerID !== currentUser.peerID);

        usersDiv.innerHTML = `
                <strong>ğŸ‘¥ NgÆ°á»i dÃ¹ng online (${otherUsers.length}):</strong> 
                ${otherUsers
                  .map(
                    (u) =>
                      `<span class="user-tag">${u.nickname || u.peerID}</span>`
                  )
                  .join("")}
            `;
      }

      // Update users display
      function updateUsersDisplay() {
        const usersDiv = document.getElementById("usersList");
        const connectedCount = connectedUsers.size;

        if (connectedCount === 0) {
          usersDiv.style.display = "none";
          return;
        }

        usersDiv.style.display = "block";
        usersDiv.innerHTML = `
                <strong>ğŸ’¬ Äang chat (${connectedCount}):</strong> 
                ${Array.from(connectedUsers)
                  .map((id) => `<span class="user-tag">${id}</span>`)
                  .join("")}
            `;
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        isManualDisconnect = true;
        stopPingInterval();

        if (chatSocket) {
          chatSocket.close();
        }
      });

      // Handle page visibility changes to manage connections
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          console.log("Page hidden - maintaining connection");
        } else {
          console.log("Page visible - checking connection");

          // Check if connection is still alive when page becomes visible
          if (chatSocket && chatSocket.readyState !== WebSocket.OPEN) {
            console.log(
              "Connection lost while page was hidden, reconnecting..."
            );
            connectToChatServer();
          }
        }
      });
    </script>
  </body>
</html>
